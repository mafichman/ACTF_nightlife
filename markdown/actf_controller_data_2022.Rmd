---
title: "ACTF Nightlife Data Analysis"
author: "Michael Fichman"
date: "June 28, 2022"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: "hide"
    code_download: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(readxl)
library(lubridate)
library(kableExtra)
library(leaflet)
library(leaflet.extras)
library(leaflet.providers)
library(sf)
library(ggmap)
library(DT)
library(tigris)
library(mapview)

plotTheme <- theme(
  plot.title =element_text(size=12),
  plot.subtitle = element_text(size=8),
  plot.caption = element_text(size = 6),
  axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
  axis.text.y = element_text(size = 10),
  axis.title.y = element_text(size = 10),
  # Set the entire chart region to blank
  panel.background=element_blank(),
  plot.background=element_blank(),
  #panel.border=element_rect(colour="#F0F0F0"),
  # Format the grid
  panel.grid.major=element_line(colour="#D0D0D0",size=.75),
  axis.ticks=element_blank())

mapTheme <- theme(plot.title =element_text(size=12),
                  plot.subtitle = element_text(size=8),
                  plot.caption = element_text(size = 6),
                  axis.line=element_blank(),
                  axis.text.x=element_blank(),
                  axis.text.y=element_blank(),
                  axis.ticks=element_blank(),
                  axis.title.x=element_blank(),
                  axis.title.y=element_blank(),
                  panel.background=element_blank(),
                  panel.border=element_blank(),
                  panel.grid.major=element_line(colour = 'transparent'),
                  panel.grid.minor=element_blank(),
                  legend.direction = "vertical", 
                  legend.position = "right",
                  plot.margin = margin(1, 1, 1, 1, 'cm'),
                  legend.key.height = unit(1, "cm"), legend.key.width = unit(0.2, "cm"))

#the magic happens here - ggmap function
ll <- function(dat, proj4 = 4326){
  st_transform(dat, proj4)
}

wage_tax_revenue <- read_excel("~/GitHub/ACTF_nightlife/data/wage-tax-revenue.xlsx") %>%
  rename(Arts_Entertainment_Recreation = 'Arts, Entertainment, and Other Recreation') %>%
  mutate(year = year(ymd(date)),
         month = month(ymd(date)))

# Load data, remove duplicates, adjust for inflation to 2021 dollars
wage_tax_revenue_new <- read.csv("https://phl-budget-datasette.herokuapp.com/revenue/wage-collections-by-sector.csv?sector__in=%5B%22Hotels%22%2C+%22Arts%2C+Entertainment%2C+and+Other+Recreation%22%2C+%22Restaurants%22%5D&_sort_desc=date&_size=max") %>%
    mutate(year = year(ymd(date)),
           month = month(ymd(date))) %>%
  select(-rowid) %>%
  group_by(fiscal_year, fiscal_quarter, sector) %>%
  slice(1) %>%
  ungroup() %>%
  mutate(total = case_when(year == 2014 ~ total * 1.12,
                           year == 2015 ~ total * 1.12,
                           year == 2016 ~ total * 1.10,
                           year == 2017 ~ total * 1.08,
                           year == 2018 ~ total * 1.06,
                           year == 2019 ~ total * 1.04,
                           year == 2020 ~ total * 1.01,
                           year == 2021 ~ total))

# County Shapefile
phila_shp <- counties("PA") %>%
  filter(NAME == "Philadelphia") %>%
  st_as_sf(crs = 4326)

# Load districts from OpenDataPhilly
councilDistricts <- st_read("https://opendata.arcgis.com/datasets/9298c2f3fa3241fbb176ff1e84d33360_0.geojson") %>%
  st_transform(crs = 4326) 

```

# About

This document contains analysis of recent data regarding wage taxes, licensing, zoning, and mobility related to Philadelphia's nighttime economy. These analyses are internal research by Philadelphia City Council's Arts and Culture Task Force, Nightlife Committee. They are presented here for public documentation, reproducibility, and transparency.

Analysis by Michael Fichman of Philadelphia City Council's Arts and Culture Task Force, Nightlife Committee. 

Wage tax revenue data obtained from Philadelphia Controller's Office, updated for the 2021 tax year, 3/8/2022. All other data obtained from Open Data Philly or Indigo Bike Share in April, May and June of 2022.

For code base used to synthesize these data, refer to the code download button at the top of this document or visit the github repository for this page - https://github.com/mafichman/ACTF_nightlife

Questions, contact mfichman@upenn.edu

# 1. Hospitality Wage Tax Receipts, 2014-2022

Quarterly wage tax receipts for industries in the arts and hospitality were dramatically impacted by the pandemic which began in March, 2020, and have not fully recovered. 

Data on nighttime-specific industries tend not to be subdivided by day and nighttime activity in wage tax data.

All dollar values adjusted for inflation (2021 dollars) based on BLS guidelines.

```{r message=FALSE, warning=FALSE, echo=FALSE}
wage_tax_revenue_new %>%
  group_by(date, sector) %>%
  summarize(sum = sum(total),
            sum = round((sum/1000000), digits = 2)) %>%
  ggplot()+
  geom_line(aes(x = as.Date(date), y=sum, color = sector))+
  ylab("Quarterly Wage Tax Revenue ($ Millions)")+
  xlab("Date")+
  labs(
    title = "Philadelphia Wage Tax Receipts for Three Hospitality Industries",
    subtitle = "Adjusted for inflation to 2021 Dollars. Source: Philadelphia City Controller's Office, BLS")+
  plotTheme
```

## 1.1. Tax revenues by year in millions of dollars

```{r message=FALSE, warning=FALSE, echo=FALSE}
wage_tax_revenue_new %>%
  group_by(year, sector) %>%
  summarize(sum = sum(total)) %>%
  mutate(sum = round((sum/1000000), digits = 2)) %>%
  spread(sector, sum) %>%
  kable() %>%
  kable_styling()

```
## 1.3. Tax Revenue in Pandemic Year 1

Year over year losses - Pandemic Year 1 - Wage tax revenues during March, 2020 - December, 2021 relative to March, 2019 - February, 2020.

As gross (in millions of US dollars, adjust for inflation to 2021 dollars) and as a percentage change.

Hospitality industries were hit much harder than the economy as a whole, where losses were ~9%

```{r message=FALSE, warning=FALSE, echo=FALSE}
wage_tax_revenue %>%
  rename("All Sectors" = Total) %>%
  mutate(pandemic = case_when(year == 2020 & month >=3 ~ "March2020_Feb2021",
                              year == 2021 ~ "March2020_Feb2021",
                              year == 2020 & month <3 ~ "March2019_Feb2020",
                              year == 2019 & month > 3 ~ "March2019_Feb2020")) %>%
  filter(is.na(pandemic) == FALSE) %>%
  select(-date, -month, -year ) %>%
  gather(-pandemic, key = "variable", value = "value") %>%
  group_by(pandemic, variable) %>%
  summarize(sum = sum(value)) %>%
  mutate(sum = round((sum/1000000), digits = 2)) %>%
  spread(pandemic, sum) %>%
  mutate(Pct_Change = round(100*((March2020_Feb2021 - March2019_Feb2020)/ March2019_Feb2020), digits = 2)) %>%
  rename("Pre-pandemic year" = March2019_Feb2020,
         "Pandemic year 1" = March2020_Feb2021) %>%
  kable() %>%
  kable_styling()

```

## 1.4. Tax Loss Estimates and Recovery Timeline

Tax revenues by the end of 2021 are still falling short of expected, meaning that recovery has not been achieved. Expected revenues are based on 2014-2020(TY Q1) trends (based on year, quarter and sector) and adjusted for inflation to 2021 dollars.

```{r model, warning = FALSE, message = FALSE, include=FALSE}
model <- lm(data = wage_tax_revenue_new %>% filter(year < 2020) %>% select(sector, fiscal_quarter, year, total), total ~ as.factor(fiscal_quarter) + year + sector)

summary(model)


predict(model, wage_tax_revenue_new) %>% 
  as.data.frame() %>% 
  rename(pred = ".") %>% 
  cbind(., wage_tax_revenue_new) -> wage_tax_revenue_new
```

Projected revenues are climbing back towards pre-pandemic status-quo.

```{r projection_chart, warning = FALSE, message = FALSE, echo=FALSE}
wage_tax_revenue_new %>%
  group_by(date, sector, year, month) %>% 
  summarize(Actual = sum(total), 
            Pre.Pandemic.Trend = sum(pred)) %>% 
  filter(year >= 2018) %>%
  ungroup() %>%
  select(date, sector, Actual, Pre.Pandemic.Trend) %>%
  gather(-sector, - date, key = "variable", value = "value") %>%
  mutate(value_m = round(value/1000000, digits = 2)) %>%
  ggplot()+
    geom_line(aes(x = as.Date(date), y=value_m, color = variable))+ 
    geom_line(aes(x = as.Date(date), y=value_m, color = variable), 
            linetype = "dashed", alpha = 0.5)+
  facet_wrap(~sector)+
    ylab("Quarterly Wage Tax Revenue ($ Millions)")+
    xlab("Date")+
    labs(
        title = "Philadelphia Wage Tax Shortfalls",
        subtitle = "Adjusted for inflation to 2021 Dollars.\n Trend based on 2014-2019 regression controlling for year, quarter, sector. \nSource: Philadelphia City Controller's Office, BLS")+
    plotTheme

```

Wage tax losses since the beginning of 2020, relative to projections based on 2014-19, are still as much as $2 million per quarter by sector.

```{r projection_chart_bar, warning = FALSE, message = FALSE, echo=FALSE}
wage_tax_revenue_new %>%
  group_by(date, sector, year, month) %>% 
  summarize(Actual = sum(total), 
            Pre.Pandemic.Trend = sum(pred)) %>% 
  mutate(loss = Actual - Pre.Pandemic.Trend) %>%
  filter(year >= 2020) %>%
  ungroup() %>%
  select(date, sector, loss) %>%
  gather(-sector, - date, key = "variable", value = "value") %>%
  mutate(value_m = round(value/1000000, digits = 2)) %>%
  ggplot()+
    geom_bar(aes(x = as.Date(date), y=value_m), stat = "identity", color = "grey")+ 
  facet_wrap(~sector)+
    ylab("Quarterly Wage Tax Revenue shortfall ($ Millions)")+
    xlab("Date")+
    labs(
        title = "Philadelphia Wage Tax Receipts vs. Pre-Pandemic Trends",
        subtitle = "Adjusted for inflation to 2021 Dollars. Source: Philadelphia City Controller's Office, BLS")+
    plotTheme

```

On a percentage basis, this looks like the following:

```{r shortfall_pct, warning = FALSE, message = FALSE, echo=FALSE}
wage_tax_revenue_new %>%
    group_by(date, sector, year, month) %>% 
    summarize(Actual = sum(total), 
              Pre.Pandemic.Trend = sum(pred), 
              pct_diff = 100*((Actual-Pre.Pandemic.Trend)/Pre.Pandemic.Trend)) %>%
    filter(year >= 2020) %>%
    ggplot()+
    geom_bar(aes(x = as.Date(date), y=pct_diff), stat = "identity", position = "dodge")+ 
    facet_wrap(~sector)+
    ylab("Quarterly Tax Revenue vs. Expected (%)")+
    xlab("Date")+
    labs(
        title = "Philadelphia Wage Tax - Percentage Shortfall vs Pre-Pandemic Trends",
        subtitle = "Adjusted for inflation to 2021 Dollars.\n Trend based on 2014-2019 regression controlling for year, quarter, sector. \nSource: Philadelphia City Controller's Office, BLS")+
    plotTheme
```

Total tax shortfalls (compared to pre-pandemic trend) since March, 2020, in millions (2021 dollars)

```{r loss_summary, echo=FALSE, message=FALSE, warning=FALSE}

wage_tax_revenue_new %>%
  group_by(date, sector, year, month) %>% 
  summarize(Actual = sum(total), 
            Pre.Pandemic.Trend = sum(pred)) %>% 
  mutate(loss = Actual - Pre.Pandemic.Trend) %>%
  ungroup() %>%
  filter(year == 2020 & month >=3 | year > 2020) %>%
  group_by(sector) %>%
  summarize("Est Loss (millions)" = round(sum(loss)/1000000, digits = 2)) %>%
  kable()

```

# 2. Amusement Tax Receipts

Data from Philadelphia City Controller's Office - 5/18/2022.

Source:

https://raw.githubusercontent.com/PhilaController/phl-budget-data/main/src/phl_budget_data/data/processed/revenue/city-collections.csv


```{r load_amusement, message=FALSE, warning=FALSE, echo=FALSE}
amusement <- read.csv("https://raw.githubusercontent.com/PhilaController/phl-budget-data/main/src/phl_budget_data/data/processed/revenue/city-collections.csv") %>%
  filter(name == "amusement") %>%
    mutate(year = year(ymd(date)),
           month = month(ymd(date))) %>%
  mutate(total = case_when(year == 2014 ~ total * 1.12,
                           year == 2015 ~ total * 1.12,
                           year == 2016 ~ total * 1.10,
                           year == 2017 ~ total * 1.08,
                           year == 2018 ~ total * 1.06,
                           year == 2019 ~ total * 1.04,
                           year == 2020 ~ total * 1.01,
                           year == 2021 ~ total, 
                           year == 2022 ~ total))

```

## 2.1. Timeline of Amusement Tax Revenues

```{r message=FALSE, warning=FALSE, echo=FALSE}
amusement %>%
  group_by(date) %>%
  summarize(sum = sum(total),
            sum = round((sum/1000000), digits = 2)) %>%
  ggplot()+
  geom_line(aes(x = as.Date(date), y=sum))+
  ylab("Monthly Amusement Tax Revenue ($ Millions)")+
  xlab("Date")+
  labs(
    title = "Philadelphia Amusement Tax Receipts",
    subtitle = "Adjusted for inflation to 2021 Dollars. Source: Philadelphia City Controller's Office")+
  plotTheme
```

```{r message=FALSE, warning=FALSE, echo=FALSE}
amusement %>%
  group_by(year) %>%
  summarize(sum = sum(total),
            sum = round((sum/1000000), digits = 2)) %>%
  ggplot()+
  geom_bar(aes(x = year, y=sum), stat = "identity")+
  ylab("Monthly Amusement Tax Revenue ($ Millions)")+
  xlab("Date")+
  labs(
    title = "Philadelphia Amusement Tax Receipts",
    subtitle = "2022 Data are through April. Adjusted for inflation to 2021 Dollars. Source: Philadelphia City Controller's Office")+
  plotTheme


```

## 1.3. Tax Loss Estimates and Recovery Timeline

Starting in late 2021, amusement tax revenues began to near pre-pandemic levels and seasonal patterns, but have only surpassed pre-2020 trends in two months since the pandemic began. Monthly tax revenues are still off between 10-50% with some strong fluctuations from month to month.

It's not clear whether this trend is homogeneous across the entertainment sector. Since March, 2020 - the total loss in amusement taxes is approximately $37.1M.

Expected revenues are based on 2014-2020(TY Q1) trends (based on OLS models incorporating year and month) and adjusted for inflation to 2021 dollars.

```{r model_amusement, warning = FALSE, message = FALSE, include=FALSE}
model_amusement <- lm(data = amusement %>% filter(year < 2020) %>% select(month, year, total), total ~ as.factor(month) + year)

summary(model_amusement)


predict(model_amusement, amusement) %>% 
  as.data.frame() %>% 
  rename(pred = ".") %>% 
  cbind(., amusement) -> amusement
```

```{r projection_chart_amusement, warning = FALSE, message = FALSE, echo=FALSE}
amusement %>%
  group_by(date, year, month) %>% 
  summarize(Actual = sum(total), 
            Pre.Pandemic.Trend = sum(pred)) %>% 
  filter(year >= 2018) %>%
  ungroup() %>%
  select(date, Actual, Pre.Pandemic.Trend) %>%
  gather(- date, key = "variable", value = "value") %>%
  mutate(value_m = round(value/1000000, digits = 2)) %>%
  ggplot()+
    geom_line(aes(x = as.Date(date), y=value_m, color = variable))+ 
    geom_line(aes(x = as.Date(date), y=value_m, color = variable), 
            linetype = "dashed", alpha = 0.5)+
    ylab("Quarterly Amusement Tax Revenue ($ Millions)")+
    xlab("Date")+
    labs(
        title = "Philadelphia Amusement Tax Shortfalls",
        subtitle = "Adjusted for inflation to 2021 Dollars.\n Trend based on 2014-2019 regression controlling for year, month. \nSource: Philadelphia City Controller's Office")+
    plotTheme

```

```{r projection_chart_bar2, warning = FALSE, message = FALSE, echo=FALSE}
amusement %>%
  group_by(date, year, month) %>% 
  summarize(Actual = sum(total), 
            Pre.Pandemic.Trend = sum(pred)) %>% 
  mutate(loss = Actual - Pre.Pandemic.Trend) %>%
  filter(year >= 2020) %>%
  ungroup() %>%
  select(date,  loss) %>%
  gather(- date, key = "variable", value = "value") %>%
  mutate(value_m = round(value/1000000, digits = 2)) %>%
  ggplot()+
    geom_bar(aes(x = as.Date(date), y=value_m), stat = "identity", color = "grey")+ 
    ylab("Monthly Amusement Tax Revenue shortfall ($ Millions)")+
    xlab("Date")+
    labs(
        title = "Philadelphia Amusement Tax Shortfall vs. Pre-Pandemic Trends",
        subtitle = "Adjusted for inflation to 2021 Dollars.\nTrend based on 2014-2019 regression controlling for year, month. \nSource: Philadelphia City Controller's Office")+
    plotTheme

```

```{r amusememt_shortfall_pct, warning = FALSE, message = FALSE, echo=FALSE}
amusement %>%
    group_by(date, year, month) %>% 
    summarize(Actual = sum(total), 
              Pre.Pandemic.Trend = sum(pred), 
              pct_diff = 100*((Actual-Pre.Pandemic.Trend)/Pre.Pandemic.Trend)) %>%
    filter(year >= 2020) %>%
    ggplot()+
    geom_bar(aes(x = as.Date(date), y=pct_diff), stat = "identity")+ 
    ylab("Tax Revenue vs. Expected (%)")+
    xlab("Date")+
    labs(
        title = "Philadelphia Amusement Tax - Percentage Shortfall vs Pre-Pandemic Trends",
        subtitle = "Adjusted for inflation to 2021 Dollars.\n Trend based on 2014-2019 regression controlling for year, month. \nSource: Philadelphia City Controller's Office, BLS")+
    plotTheme
```

Estimated total losses in Amusement tax revenue since March, 2020. Based on differences between actual and predicted revenues from OLS regression controlling for year and seasonality (month), in 2021 dollars

```{r loss_summary_amusement, echo=FALSE, message=FALSE, warning=FALSE}

amusement %>%
  group_by(date, year, month) %>% 
  summarize(Actual = sum(total), 
            Pre.Pandemic.Trend = sum(pred)) %>% 
  mutate(loss = Actual - Pre.Pandemic.Trend) %>%
  ungroup() %>%
  filter(year == 2020 & month >=3 | year > 2020) %>%
  summarize("Est Loss (millions)" = round(sum(loss)/1000000, digits = 2)) %>%
  kable()

```

# 3. Save Our Stages Grants

This repo contains interactive maps and analysis of SBA Grants given as part of the "Save Our Stages" Act passed by the US Congress.

The data being used here have been geocoded using the Google Geocoding service, which is highly accurate but not error free. Data are current as of August 17, 2021, and are available [from the SBA](https://data.sba.gov/dataset/svog/resource/33270c2a-f1c5-4dcb-bc98-aedcaec19ef3).

## 3.1. Grantee map

The following map shows the grantee locations.

```{r venues, echo = FALSE, message = FALSE, warning = FALSE}
geocoded_venues <- read.csv("~/GitHub/SaveOurStagesGrants/data/geocoded_venues.csv") %>%
  rename(acct_type = 'Account.Venue') %>%
  filter(City == "Philadelphia" & State == "PA")

l <- leaflet() %>% 
  addProviderTiles(providers$Esri.WorldTopoMap) %>%
  setView(lng = mean(geocoded_venues$lon, na.rm = TRUE),
          lat = mean(geocoded_venues$lat, na.rm = TRUE),
          zoom = 10) %>%
  addScaleBar(position = "topleft") %>%
  addCircleMarkers(data= geocoded_venues %>%
                     filter(acct_type == "Live performing arts organization operator"),
                   lng=~lon, 
                   lat=~lat,
                   radius =~ 1, 
                   fillOpacity =~ 0.5,
                   color= "blue", # "~pal(acct_type)"
                   label=~paste(svog_grantee, " | Grant $", svog_amount),
                   group= "Live performing arts organization operator") %>%
  addCircleMarkers(data= geocoded_venues %>%
                     filter(acct_type == "Live venue operator or promoter"),
                   lng=~lon, 
                   lat=~lat,
                   radius =~ 1, 
                   fillOpacity =~ 0.5,
                   color= "blue", # "~pal(acct_type)"
                   label=~paste(svog_grantee, " | Grant $", svog_amount),
                   group= "Live venue operator or promoter") %>%
  addCircleMarkers(data= geocoded_venues %>%
                     filter(acct_type == "Motion picture theater operator"),
                   lng=~lon, 
                   lat=~lat,
                   radius =~ 1, 
                   fillOpacity =~ 0.5,
                   color= "blue", # "~pal(acct_type)"
                   label=~paste(svog_grantee, " | Grant $", svog_amount),
                   group= "Motion picture theater operator") %>%
  addCircleMarkers(data= geocoded_venues %>%
                     filter(acct_type == "Museum Operator"),
                   lng=~lon, 
                   lat=~lat,
                   radius =~ 1, 
                   fillOpacity =~ 0.5,
                   color= "blue", # "~pal(acct_type)"
                   label=~paste(svog_grantee, " | Grant $", svog_amount),
                   group= "Museum Operator") %>%
  addCircleMarkers(data= geocoded_venues %>%
                     filter(acct_type == "Talent representative"),
                   lng=~lon, 
                   lat=~lat,
                   radius =~ 1, 
                   fillOpacity =~ 0.5,
                   color= "blue", # "~pal(acct_type)"
                   label=~paste(svog_grantee, " | Grant $", svog_amount),
                   group= "Talent representative") %>%
  addCircleMarkers(data= geocoded_venues %>%
                     filter(acct_type == "Theatrical producer"),
                   lng=~lon, 
                   lat=~lat,
                   radius =~ 1, 
                   fillOpacity =~ 0.5,
                   color= "blue", # "~pal(acct_type)"
                   label=~paste(svog_grantee, " | Grant $", svog_amount),
                   group= "Theatrical producer") %>%
  addLayersControl(
    overlayGroups = c("Live performing arts organization operator", 
                      "Live venue operator or promoter",
                      "Motion picture theater operator",
                      "Museum Operator",
                      "Talent representative",
                      "Theatrical producer") ,
    options = layersControlOptions(collapsed = TRUE)
    ) %>%
  hideGroup(c("Live performing arts organization operator", 
                      "Motion picture theater operator",
                      "Museum Operator",
                      "Talent representative",
                      "Theatrical producer"))

l

```
## 3.2. Philadelphia SVOG grant breakdown:

```{r svog_breakdown, message = FALSE, echo = FALSE, warning = FALSE}
geocoded_venues %>%
  summarize("Num Grants" = n(),
            "Grants Total" = sum(svog_amount),
            "Mean Grant" = mean(svog_amount),
            "Median Grant" = median(svog_amount)) %>%
  kable() %>%
  kable_styling()
```

## 3.3. Phila SVOG searchable database:

```{r searchable_table, echo=FALSE, message=FALSE, warning=FALSE}
datatable(geocoded_venues %>%
            select(-X, -lon, -lat, -address_full) %>%
            rename('Grant ($)' = svog_amount,
                   Grantee = svog_grantee,
                   Category = acct_type), 
          options = list(pageLength = 10))
```


# 4. Zoning and Assembly Licenses

A Special Assembly Occupancy License (SAOL) is the highest form of license for assembly for entertainment for 50+ people (non-seated). In combination with an amusement license and regular business licenses, this is what you usually need to open a venue. These licenses are difficult to get, and can be expensive. Much expense and risk is incurred when you need a zoning variance (and council approval) or to go through a zoning process triggered by a special exception.

SAOLs are only available by right in very few zoning categories, most of these the most expensive land in Center City. Recently, people have NOT been taking out licenses in CC, they have been going through zoning processes in nearby neighborhoods with transit access and clusters of amenities, and SAOLs have been going extinct much faster than they are being created.

There are a few opportunities for Council to make SAOLs easier to access - one is by supporting operators in getting variances, two is by opening up more zoning districts to SAOLs by right.

[24HrPHL put together a "playbook" for how to obtain a SAOL in 2019 that was vetted by then L&I Commissioner Dave Perri.](http://24hrphl.org/the-venue-starter-playbook/)

The number of active SAOLs in Philadelphia is declining, and the places where people want to (or can afford to) build creative spaces are not the places where they are available by-right. Only 28% of active SAOLs are in by-right districts - rate of by-right development of SAOL businesses has been relatively constant for over 15 years.

Frequently, people are applying for SAOLs in CMX-2.5 properties - where this use is availabe by special exception *Opening CMX-2.5 to by-right SAOL would more than double the amount of commercial parcels eligible for by-right SAOL.*

```{r dl_zoning, echo=FALSE, message=FALSE, warning=FALSE, echo=FALSE, comment = FALSE}

zones <- st_read("https://opendata.arcgis.com/datasets/0bdb0b5f13774c03abf8dc2f1aa01693_0.geojson") %>%
  st_as_sf(crs = 4326) %>%
  mutate(assembly_allowed = ifelse(LONG_CODE %in% 
                                     c("CMX-4", "CMX-5", "CA-2", "ICMX"),
                                   "By-Right", 
                                   ifelse(LONG_CODE %in% 
                                            c("CMX-2", "CMX-2.5", "CMX-3", "IRMX"),
                                          "Special Exception", 
                                          "Not Permitted" )))

licenses <- st_read("https://phl.carto.com/api/v2/sql?q=SELECT+*+FROM+business_licenses&filename=business_licenses&format=geojson&skipfields=cartodb_id") %>%
  st_as_sf(crs = 4326)

```
## 4.1. Summary of SAOL-eligible Districts

Assembly is allowed by right in four zoning districts, and by special exception in four others.

Here are some very basic descriptions of these types of zones, with information sourced from Anastasio Law - http://phillyzoning.com/

*By Right*

-CA-2 - Auto-oriented commercial

-CMX-4 - Commercial Mixed Use, mostly found in Center City or along major arterials like Broad, Market or Chestnut Streets

-CMX-5 - Commercial Mixed Use, found in the core of Center City office districts

-ICMX - Commercial/Industrial uses designed as a buffer between commercial and residential uses

*Special Exception*

-CMX-2 - Neighborhood commercial corridor, mixed use - e.g. Baltimore Avenue, Germantown Avenue

-CMX-2.5 - Commercial mixed use designed to promote pedestrian-friendly uses

-CMX-3 - Lower density commercial mixed use than CMX 4&5, found on major corridors like Kensington Ave, South St, Broad south of Washington.

-IRMX - "Low impact" industrial, including artist spaces

```{r explore_zones, message = FALSE, warning = FALSE, echo=FALSE, eval = FALSE}
zones %>%
  as.data.frame()%>%
  filter(LONG_CODE %in% c("CMX-4", "CMX-5", "CA-2", "ICMX", "CMX-2", "CMX-2.5", "CMX-3", "IRMX")) %>%
  group_by(assembly_allowed, LONG_CODE) %>%
  tally() %>%
  rename("Parcels city-wide" = n,
         District = LONG_CODE) %>%
  kable %>%
  kable_styling()
```

City-wide, roughly 26% of *commercial* districts (by area) are zoned for assembly by right. Much of this area is in large Center City tracts where creative spaces are unlikely to be developed due to cost or constraints of the land.

```{r pct_commercial_props, message = FALSE, warning = FALSE, echo=FALSE}
zones %>%
  filter(str_detect(ZONINGGROUP, "Commercial") == TRUE) %>%
  st_transform(2272) %>%
  mutate(area = st_area(.)) %>%
  as.data.frame()%>%
  group_by(assembly_allowed) %>%
  summarize(sum_area = sum(area)) %>%
  #rename(n_parcels = n) %>%
  mutate(Pct = round(100*(sum_area / sum(sum_area)), 2)) %>%
  #rename("Parcels City-Wide" = n_parcels) %>%
  kable() %>%
  kable_styling()
```

## 4.2. City-wide zoning examination

The majority of areas zoned for assembly by-right are in Center City. This is *not* where most development of creative entertainment is taking place.

Take a look at districts outside Center City like Fishtown - by-right SAOL is not really allowed by-right anywhere.

```{r map_exceptions, message = FALSE, warning = FALSE, echo=FALSE, fig.width=8, fig.height= 8}
mapview(zones %>%
          filter(assembly_allowed %in% c("Special Exception", "By-Right")) %>%
          mutate(LONG_CODE = case_when(LONG_CODE == "CA-2" ~ "By-Right CA-2",
                                       LONG_CODE == "CMX-4" ~ "By-Right CMX-4",
                                       LONG_CODE == "CMX-5" ~ "By-Right CMX-5",
                                       LONG_CODE == "ICMX" ~ "By-Right ICMX",
                                       LONG_CODE == "CMX-2" ~ "Spec Execpt CMX-2",
                                       LONG_CODE == "CMX-2.5" ~ "Spec Execpt CMX-2.5",
                                       LONG_CODE == "CMX-3" ~ "Spec Execpt CMX-3",
                                       LONG_CODE == "IRMX" ~ "Spec Execpt IRMX")),
        zcol = "LONG_CODE", col.regions=list("#ffffb2", "#fecc5c", "#fd8d3c", "#e31a1c",
                                             "#edf8fb", "#b3cde3", "#8c96c6", "#88419d"),
        col = list("transparent"),
        layer.name = "Zoning Districts") +
  mapview(licenses %>% 
  filter(licensetype == "Special Assembly Occupancy",
         licensestatus == "Active") %>% 
  st_join(., zones), zcol = "assembly_allowed" ,layer.name = "SAOL License")

```

These static maps represent the same information but are designed to be used in the Task Force written report or with printed materials.

SAOL zoning status:

```{r static_map2, echo=FALSE, fig.height=6, fig.width=6, message=FALSE, warning=FALSE}
ggplot()+ 
  geom_sf(data = phila_shp, fill = "black") + 
  geom_sf(data = zones %>% 
            filter(assembly_allowed %in% c("Special Exception", "By-Right")), 
          aes(fill = assembly_allowed), 
          color = "transparent",
          alpha = 0.7)+ 
  scale_fill_manual(values = c("blue", "yellow"))+
  theme(legend.title=element_blank())+
  mapTheme
```


SAOL license locations, by zoning status:


```{r static_map1, echo=FALSE, message=FALSE, warning=FALSE, fig.height=6, fig.width=6,}
ggplot()+ 
  geom_sf(data = phila_shp, fill = "black") + 
  geom_sf(data = licenses %>% 
            filter(licensetype == "Special Assembly Occupancy", 
                   licensestatus == "Active") %>% 
            st_join(., zones) %>% 
            filter(is.na(assembly_allowed) == FALSE), 
          aes(color = assembly_allowed), 
          size = .5,
          alpha = 0.6) + 
  scale_color_manual(values = c("blue",  "red" , "yellow"))+ 
  theme(legend.title=element_blank())+
  mapTheme
```

```{r get_basemap, echo=FALSE, message=FALSE, warning=FALSE}
base_map <- get_stamenmap(bbox = unname(st_bbox(ll(st_buffer(phila_shp,1500)))),
                          force = TRUE, maptype = "toner-lines", zoom = 11)
```
``` {r map_all, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}

ggmap(base_map,
      alpha = .8)+
  geom_sf(data = ll(phila_shp), 
          inherit.aes = FALSE,
          fill = "transparent", 
          color = "orange",
          size = .5,
          alpha = 0.5) +
  geom_sf(data = ll(licenses %>% 
                      filter(licensetype == "Special Assembly Occupancy", 
                             licensestatus == "Active") %>% 
                      st_join(., zones)) %>%
            filter(is.na(assembly_allowed) == FALSE) %>%
                      st_transform(st_crs(phila_shp)), 
          aes(color = assembly_allowed),
          inherit.aes = FALSE,,
          size = 1.2,
          alpha = 0.7)+
  scale_color_manual(values = c("blue",  "red" , "yellow"))+ 
  theme(legend.title=element_blank())+
  mapTheme

```

``` {r map_all_facet, echo=FALSE, message=FALSE, warning=FALSE}

ggmap(base_map)+
  geom_sf(data = ll(phila_shp), 
          inherit.aes = FALSE,
          fill = "transparent", 
          color = "blue",
          size = 1) +
  geom_sf(data = ll(licenses %>% 
                      filter(licensetype == "Special Assembly Occupancy", 
                             licensestatus == "Active") %>% 
                      st_join(., zones)) %>%
                      st_transform(st_crs(phila_shp)) %>%
            filter(is.na(assembly_allowed) == FALSE), 
          aes(color = assembly_allowed),
          inherit.aes = FALSE,,
          color = "red",
          alpha = 0.7,
          size = 1)+
  theme(legend.title=element_blank())+
  facet_wrap(~assembly_allowed)+
  mapTheme

```
``` {r basemap_facet_zoom, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}

base_map_zoom <- get_stamenmap(bbox = unname(st_bbox(ll(st_buffer(st_centroid(councilDistricts %>% 
                                              filter(DISTRICT %in% c( 1, 2, 3, 5))),6000)))),
                          force = TRUE, maptype = "terrain", zoom = 12)
```

``` {r map_all_facet_zoom, echo=FALSE, message=FALSE, warning=FALSE}
ggmap(base_map_zoom)+
  geom_sf(data = councilDistricts %>% 
            #filter(DISTRICT %in% c( 1, 2, 3, 5)) %>%
            st_transform(crs = 4326), inherit.aes = FALSE,
          fill = "transparent", color = "blue", size = .75, alpha = 0.2)+
  geom_sf_label(data = councilDistricts %>% 
                  filter(DISTRICT != 1) %>%
            st_transform(crs = 4326), inherit.aes = FALSE,
            aes(label = DISTRICT),
            label.size = 0.25)+
  geom_sf_label(data = councilDistricts %>% 
                  filter(DISTRICT == 1) %>%
            st_transform(crs = 4326), inherit.aes = FALSE,
            aes(label = DISTRICT),
            label.size = 0.25,
            nudge_y = -.02)+
  geom_sf(data = ll(licenses %>% 
                      filter(licensetype == "Special Assembly Occupancy", 
                             licensestatus == "Active") %>% 
                      st_join(., zones)) %>%
                      st_transform(st_crs(4326)) %>%
            filter(is.na(assembly_allowed) == FALSE), 
          aes(color = assembly_allowed),
          inherit.aes = FALSE,,
          color = "red",
          alpha = 0.7,
          size = 1)+
  theme(legend.title=element_blank())+
  facet_wrap(~assembly_allowed)+
  mapTheme

```

``` {r by_right, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}

ggmap(base_map)+
  geom_sf(data = ll(phila_shp), 
          inherit.aes = FALSE,
          fill = "transparent", 
          color = "blue",
          size = 1) +
  geom_sf(data = ll(licenses %>% 
                      filter(licensetype == "Special Assembly Occupancy", 
                             licensestatus == "Active") %>% 
                      st_join(., zones) %>% 
                      filter(assembly_allowed == "By-Right") %>%
                      st_transform(st_crs(phila_shp))), 
          inherit.aes = FALSE,
          color = "red",
          size = 1,
          alpha = 0.7)+
  ggtitle("By Right") +
  mapTheme

```

``` {r special_exception, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}

ggmap(base_map)+
  geom_sf(data = ll(phila_shp), 
          inherit.aes = FALSE,
          fill = "transparent", 
          color = "blue") +
  geom_sf(data = ll(licenses %>% 
                      filter(licensetype == "Special Assembly Occupancy", 
                             licensestatus == "Active") %>% 
                      st_join(., zones) %>% 
                      filter(assembly_allowed == "Special Exception") %>%
                      st_transform(st_crs(phila_shp))), 
          inherit.aes = FALSE,
          color = "red",
          size = 1,
          alpha = 0.7)+
  ggtitle("Special Exception") +
  mapTheme

```

``` {r not_permitted, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}

ggmap(base_map)+
  geom_sf(data = ll(phila_shp), 
          inherit.aes = FALSE,
          fill = "transparent", 
          color = "blue") +
  geom_sf(data = ll(licenses %>% 
                      filter(licensetype == "Special Assembly Occupancy", 
                             licensestatus == "Active") %>% 
                      st_join(., zones) %>% 
                      filter(assembly_allowed == "Not Permitted") %>%
                      st_transform(st_crs(phila_shp))), 
          inherit.aes = FALSE,
          color = "red",
          size = 1,
          alpha = 0.7)+
  ggtitle("Not Permitted") +
  mapTheme

```

```{r council districts, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}

licenses %>% 
            filter(licensetype == "Special Assembly Occupancy", 
                   licensestatus == "Active") %>% 
            st_join(., zones) %>% 
            filter(is.na(assembly_allowed) == FALSE) %>%
  as.data.frame() %>%
  group_by(assembly_allowed, council_district) %>%
  tally() %>%
  ggplot()+
  geom_bar(aes(x = council_district, y = n, fill= assembly_allowed), 
           stat = "identity", position = "dodge")+
  plotTheme

```

## 4.3. SAOL issuance timeline

There are currently 121 SAOLs active in Philly, and 88 of those license holders also have amusement licenses.

Very few SAOLs are issued in Philly, and especially few the last two years. The following chart shows the date when SAOL's were issued. 2006 probably has data inflated by the start of the record-keeping period for these data.

```{r license_timeline, echo=FALSE, message=FALSE, warning=FALSE}
licenses %>%
  filter(licensetype == "Special Assembly Occupancy") %>%
  mutate(year_opened = year(as.Date(initialissuedate))) %>%
  group_by(year_opened) %>%
  tally() %>%
  ggplot()+
  geom_histogram(aes(y = n, x = year_opened), stat = "identity") +
  labs(title="Special Assembly Occupancy License Active Dates",
       subtitle= "Data through May, 2022. Source: Philadelphia Dept. Of Licenses & Inspections",
       x="Year", 
       y="Number of Licenses Activated")+
  plotTheme

```

Record numbers of licenses became inactive in 2020... The following chart shows the years in which SAOL's became inactive. Meanwhile, the real estate market is getting much more competitive and entertainment wages are slow to recover (see Section 1 of this document).

```{r license_timeline_inactive, echo=FALSE, message=FALSE, warning=FALSE}
licenses %>%
  filter(licensetype == "Special Assembly Occupancy",
         licensestatus != "Active") %>%
  mutate(year_closed = year(as.Date(expirationdate))) %>%
  group_by(year_closed) %>%
  tally() %>%
  ggplot()+
  geom_histogram(aes(y = n, x = year_closed), stat = "identity") +
  labs(title="Special Assembly Occupancy License Expiration Dates",
       subtitle= "Data through May, 2022. Source: Philadelphia Dept. Of Licenses & Inspections",
       x="Year", 
       y="Number of Licenses Inactivated,")+
  plotTheme

```

```{r license_timeline_inactive3, echo=FALSE, message=FALSE, warning=FALSE}
licenses %>%
  filter(licensetype == "Special Assembly Occupancy",
         licensestatus != "Active") %>%
  mutate(year = year(as.Date(expirationdate))) %>%
  as.data.frame() %>%
  group_by(year) %>%
  tally() %>%
  mutate(Action = "Expired") %>%
  rbind(., 
  licenses %>%
  mutate(year = year(as.Date(initialissuedate))) %>%
    filter(licensetype == "Special Assembly Occupancy") %>%
    as.data.frame() %>%
  group_by(year) %>%
  tally() %>%
  mutate(Action = "Activated")) %>%
  filter(year < 2022 & year > 2006) %>%
  ggplot()+
  geom_line(aes(y = n, x = year, color = Action), stat = "identity") +
  labs(title="Special Assembly Occupancy License Issuance and Closure",
       subtitle= "Data through May, 2022. Source: Philadelphia Dept. Of Licenses & Inspections",
       x="Year", 
       y="Number of Licenses")+
  plotTheme

```

```{r license_timeline_inactive4, echo=FALSE, message=FALSE, warning=FALSE}
licenses %>%
  filter(licensetype == "Special Assembly Occupancy",
         licensestatus != "Active") %>%
  mutate(year = year(as.Date(expirationdate))) %>%
  as.data.frame %>%
  group_by(year) %>%
  tally() %>%
  rename(inactivated = n) %>%
  full_join(., 
  licenses %>%
    filter(licensetype == "Special Assembly Occupancy") %>%
  mutate(year = year(as.Date(initialissuedate))) %>%
    as.data.frame() %>%
  group_by(year) %>%
  tally() %>%
  rename(activated = n)) %>%
  arrange(year) %>%
  mutate(inactivated = ifelse(is.na(inactivated) == TRUE, 0, inactivated),
    yearly_net = activated - inactivated,
         active_licenses = cumsum(yearly_net)) %>%
  filter(year >2009 & year < 2023) %>%
  ggplot()+
  geom_bar(aes(y = active_licenses, x = year), stat = "identity") +
  labs(title="Active Special Assembly Occupancy Licenses",
       subtitle= "Activations Minus Expirations By Year from Records 1/2005 - 5/2022. Source: Philadelphia Dept. Of Licenses & Inspections",
       x="Year", 
       y="Number of Licenses")+
  plotTheme

```

## 4.4. SAOLs and By-Right Zoning

Among active Special Assembly Occupancy Licenses, only 35 (28%) were permitted by right in the zones where they were created.

```{r licenses_and_zones1, echo=FALSE, warning = FALSE, message = FALSE}
licenses %>% 
  filter(licensetype == "Special Assembly Occupancy",
         licensestatus == "Active") %>% 
  st_join(., zones) %>% 
  as.data.frame() %>%
  group_by(assembly_allowed, LONG_CODE) %>% 
  tally() %>%
  rename(n_licenses = n) %>%
  left_join(., zones %>%
              as.data.frame() %>%
              group_by(LONG_CODE) %>%
              tally() %>%
              rename( total_zone_parcels = n)) %>%
  group_by(assembly_allowed, LONG_CODE) %>%
  summarize(n_licenses = sum(n_licenses)) %>%
  ungroup() %>%
  mutate(pct = round(100*(n_licenses / sum(n_licenses)),2)) %>%
  kable()  %>%
  kable_styling()
  
```
```{r licenses_and_zones2, echo=FALSE, warning = FALSE, message = FALSE}
licenses %>% 
  filter(licensetype == "Special Assembly Occupancy",
         licensestatus == "Active") %>% 
  st_join(., zones) %>% 
  as.data.frame() %>%
  group_by(assembly_allowed, LONG_CODE) %>% 
  tally() %>%
  rename(n_licenses = n) %>%
  left_join(., zones %>%
              as.data.frame() %>%
              group_by(LONG_CODE) %>%
              tally() %>%
              rename( total_zone_parcels = n)) %>%
  group_by(assembly_allowed) %>%
  summarize(n_licenses = sum(n_licenses)) %>%
  ungroup() %>%
  mutate(pct = round(100*(n_licenses / sum(n_licenses)),2)) %>%
  kable() %>%
  kable_styling()
  
```


Has this phenomenon been changing over time? Not much in the last 15 years!

```{r licenses_and_zones3, echo=FALSE, warning = FALSE, message = FALSE}
licenses %>% 
  filter(licensetype == "Special Assembly Occupancy") %>% 
  mutate(year_issued = year(as.Date(initialissuedate))) %>%
  st_join(., zones) %>% 
  as.data.frame() %>%
  group_by(assembly_allowed, year_issued) %>% 
  tally() %>%
  rename(n_licenses = n) %>%
  ungroup()%>%
  left_join(., licenses %>% 
    filter(licensetype == "Special Assembly Occupancy") %>% 
    mutate(year_issued = year(as.Date(initialissuedate))) %>%
    group_by(year_issued) %>%
    tally() %>%
      rename(total_licenses = n)) %>%
  mutate(pct = 100*(n_licenses / total_licenses)) %>%
  filter(assembly_allowed == "By-Right") %>%
  ggplot()+
  geom_line(aes(x = year_issued, y = pct))+
  labs(title="Pct of Special Assembly Occupancy License Issuance By-Right",
       x="Year", 
       y="Pct of total SAOLs")+
  plotTheme
  
```

# 5. Amusement Licenses

Here is an activation/inactivation timeline for amusement licenses - these data appear to start being reliable in about 2015 - in 2014, hundreds of licenses were added to the register (possibly due to a recording sprint).

```{r amusement_license_timeline_inactive3, echo=FALSE, message=FALSE, warning=FALSE}
licenses %>%
  filter(licensetype == "Amusement",
         licensestatus != "Active") %>%
  mutate(year = year(as.Date(expirationdate))) %>%
  as.data.frame %>%
  group_by(year) %>%
  tally() %>%
  rename(inactivated = n) %>%
  full_join(., 
  licenses %>%
    filter(licensetype == "Amusement") %>%
  mutate(year = year(as.Date(initialissuedate))) %>%
    as.data.frame() %>%
  group_by(year) %>%
  tally() %>%
  rename(activated = n)) %>%
  arrange(year) %>%
  mutate(inactivated = ifelse(is.na(inactivated) == TRUE, 0, inactivated),
    yearly_net = activated - inactivated,
         active_licenses = cumsum(yearly_net)) %>%
  filter(year >2007 ) %>%
  ggplot()+
  geom_bar(aes(y = active_licenses, x = year), stat = "identity") +
  labs(title="Active Amusement Licenses",
       subtitle= "Activations Minus Expirations By Year from Records 1/2005 - 5/2022. Source: Philadelphia Dept. Of Licenses & Inspections",
       x="Year", 
       y="Number of Licenses")+
  plotTheme

```

Next steps - 

How is this related to property costs / tax rates / valuation?
How many can we verify are music venues vs, say adult entertainment?
Are temporary assembly licenses in the data set?
How good are these data, really?


# 6. Firearm Incidents at Night in Philadelphia

There is ongoing concern about gun crime in Philadelphia. Gun crime is rising for the city as a whole. 2021 was a particularly bad year for gun crime. [According to FBI's uniform crime report](https://crime-data-explorer.app.cloud.gov/pages/explorer/crime/crime-trend), national rates of violent crime are down substantially from peak recorded levels in the 1990s.

This section analyzes [Philadelphia Police Department (PPD) firearm incident reports](https://www.opendataphilly.org/dataset/crime-incidents) from January, 2017 to June, 2022 in relation to the location of Commerce Dept. designated [commercial corridors]https://www.opendataphilly.org/dataset/commercial-corridors, and the location of [food service, sidewalk cafe, special assembly occupancy, and entertainment licenses](https://www.opendataphilly.org/dataset/licenses-and-inspections-business-licenses). We do not have specific information about when specific establishments open or close.

Keep in mind that these are reported incidents - subject to bias in observation, reporting, and classification.

The major takeaways from our analysis are as follows:

1. Firearm incidents are rising for the city as a whole. 

2. Most incidents happen at night, between approximately 11PM and 1AM. 

3. Gun crime at night mostly happens away from establishments in commercial corridors (~88%), and mostly concentrated in neighborhoods with high volumes of incidents.

4. If you are near a licensed establishment at night in a place with relatively low gun crime, you are much, much less likely to be exposed to an incident than if you are elsewhere.

5. Eastern segments of South Street are some of the highest traffic local nightlife corridors and draw a very wide scope of visitors, but have comparatively low frequencies of incidents.

```{r load_crime_data, echo=FALSE, message=FALSE, warning=FALSE}
# https://cityofphiladelphia.github.io/carto-api-explorer/#incidents_part1_part2
# Jan 1, 2017 to June 27, 2022
philaCrime <- read.csv("https://phl.carto.com/api/v2/sql?filename=incidents_part1_part2&format=csv&q=SELECT%20*%20,%20ST_Y(the_geom)%20AS%20lat,%20ST_X(the_geom)%20AS%20lng%20FROM%20incidents_part1_part2%20WHERE%20dispatch_date_time%20%3E=%20%272017-01-01%27%20AND%20dispatch_date_time%20%3C%20%272022-06-27%27")

# Keep only violent crime types, fix typos in homicide data entry,
# Create time variables
# Filter out data with bad geometry information

violentCrime <- philaCrime %>% 
  filter(text_general_code %in% c("Other Assaults", 
                                               "Thefts", 
                                               "Aggravated Assault Firearm", 
                                               "Aggravated Assault No Firearm", 
                                               "Robbery Firearm", 
                                               "Robbery No Firearm", 
                                               "Homicide - Criminal", 
                                               "Homicide - Criminal ", 
                                               "Rape", 
                                               "Other Sex Offenses (Not Commercialized")) %>%
  mutate(text_general_code = ifelse(str_detect(text_general_code, "Homicide") == TRUE,
         "Homicide - Criminal", text_general_code)) %>%
  mutate(interval60 = floor_date(ymd(dispatch_date), unit = "hour"),
         week = week(interval60),
         month = month(interval60),
         dotw = wday(interval60, label=TRUE),
         year = year(interval60),
         hour = hour(hms(dispatch_time))) %>%
  mutate(after_six = ifelse(hour > 17 | hour < 7, "6PM - 6AM", "6AM - 6PM"))

# Spatialize data, drop data without spatial info

violentCrime_shp <- violentCrime %>%
  filter(point_y > 1,
         point_x > -76,
         point_x < -73) %>%
  st_as_sf(coords = c("lng", "lat"), crs = 4326) %>%
  st_transform(2272)

# Take the licenses for restaurants, amusement, assembly, food establishment
# Create 200 ft buffers around current licenses
# Then do a similar thing for older licenses for comparison - maybe 2018 or 19

nightLicenses <- st_read("https://phl.carto.com/api/v2/sql?q=SELECT+*+FROM+business_licenses&filename=business_licenses&format=geojson&skipfields=cartodb_id") %>%
  filter(licensetype %in% c("Amusement", "Special Assembly Occupancy", "Sidewalk Cafe") |
           str_detect(licensetype, "Food Estab")) %>%
  st_transform(crs = 2272)

current_buffer <- nightLicenses %>%
  filter(licensestatus == "Active") %>%
  st_union() %>%
  st_buffer(200) %>%
  st_as_sf(crs = 2272) %>%
  mutate(in_buffer = "in buffer")

# Load Corridors

corridors <- st_read("https://opendata.arcgis.com/datasets/f43e5f92d34e41249e7a11f269792d11_0.geojson") %>%
  st_as_sf() %>%
  st_transform(crs = 2272)

```

## 6.1. Time patterns of firearm incidents

We examined a category of incidents recorded between January 1, 2017 and June 27, 2022 - incidents classified by the PPD as Criminal Homicide, Robbery with a Firearm, Aggravated Assault with a Firearm.

```{r total_gun_incidents, echo=FALSE, warning = FALSE, message = FALSE}
violentCrime %>%
    filter(text_general_code %in% c("Aggravated Assault Firearm", 
                                    "Robbery Firearm", 
                                    "Homicide - Criminal", 
                                    "Homicide - Criminal ")) %>%
    group_by(text_general_code, year, month) %>%
    tally() %>%
    mutate(date = lubridate::my(paste(month, year))) %>%
    ggplot()+
    geom_line(aes(x = date, y = n, color = text_general_code))+
    ylim(0, 500)+
    labs(title="Monthly Firearm Incidents By Type, 2017-2022",
         subtitle= "Source: Philadelphia Police Dept.",
         x="Year", 
         y="Monthly Reported Incidents")+
    plotTheme

```

```{r day_and_time, echo=FALSE, warning = FALSE, message = FALSE }

violentCrime %>%
  filter(text_general_code %in% c("Aggravated Assault Firearm", 
                                  "Robbery Firearm", 
                                  "Homicide - Criminal", 
                                  "Homicide - Criminal ")) %>%
  group_by(after_six, year, month) %>%
  tally() %>%
  mutate(date = lubridate::my(paste(month, year))) %>%
  ggplot()+
  geom_line(aes(x = date, y = n, color = after_six))+
    ylim(0, 500)+
  labs(title="Monthly Firearm Incidents By Time of Day, 2017-2022",
       subtitle= "Homicide, Aggravated Assault, Robbery with Firearms.\n Source: Philadelphia Police Dept.",
       x="Year", 
       y="Monthly Reported Incidents")+
  plotTheme
```

Most gun crime, overall, happens in the evening, between about 11 PM and 1AM, with much of it concentrated around midnight. 

```{r all_crimes_day, echo=FALSE, warning = FALSE, message = FALSE}
violentCrime %>%
  filter(year > 2020) %>%
  filter(text_general_code %in% c("Aggravated Assault Firearm", 
                                  "Robbery Firearm", 
                                  "Homicide - Criminal", 
                                  "Homicide - Criminal ")) %>%
  group_by(hour, dotw) %>%
  tally() %>%
  ggplot()+
  geom_line(aes(x= hour, y = n))+
  facet_wrap(~dotw)+
  labs(title="Hourly Reported Firearm Incidents, 2017-2022",
       subtitle= "Homicide and Aggravated Assault, Robbery with Firearms.\n Source: Philadelphia Police Dept.",
       x="Hour of the Day", 
       y="Hourly Reported Incidents")+
  plotTheme

```

The following plots show all firearm incidents since 2020, broken down by day of the week and hour reported. The 12PM (0h) time of day has the highest reporting count by far of any time of day. It is unclear how much of that is related to record-keeping practices, but it doesn't seem like there's a pattern.


## 6.2. Spatial Pattern of Nighttime Incidents

We related these firearm incidents (and other violent crime incidents) to two types of data, wanting to know how frequently incidents were happening near hospitality locations at night.

1. Philadelphia Licenses and Inspections records of Amusement, Special Assembly Occupancy Licenses, Sidewalk Cafe licenses, and any type of Food Establishment License. and 

2. Commercial corridor boundaries kept by the Department of Commerce.

Keep in mind - we do not know particularly when these establishments are open and closed. We don't know if an incident at 11PM outside a restaurant happens while that restaurant is in active operation. We filtered out incidents that took place near license locations when those licenses were not active (e.g. before they were created).

-----

We examined a wide variety of violent crimes in commercial corridors and within 200 feet of restaurants, assembly and amusement businesses. This timeline shows that at any time of day, any day of the week, there are far more incidents of aggravated assault, robbery, theft, rape, sexual crimes, and homicide away from areas of hospitality activity.

It is substantially more likely one will be exposed to a violent crime at almost any hour of the day away from a licensed establishment at any time of day, as compared to a weekend night near a licensed establishment.

```{r all_crimes_200_ft, echo=FALSE, warning = FALSE, message = FALSE}
st_join(violentCrime_shp %>% 
          filter(year > 2020) %>%
          filter(text_general_code %in% c("Aggravated Assault Firearm", 
                                          "Aggravated Assault No Firearm", 
                                          "Robbery Firearm", 
                                          "Robbery No Firearm", 
                                          "Homicide - Criminal", 
                                          "Homicide - Criminal ", 
                                          "Rape", 
                                          "Other Sex Offenses (Not Commercialized)")), current_buffer) %>%
  mutate(Proximate_To_License = ifelse(is.na(in_buffer) == TRUE, "Over 200 ft Away", "Within 200 ft")) %>%
  group_by(Proximate_To_License, dotw, hour) %>%
  tally() %>%
    ggplot()+
    geom_bar(aes(x = hour, y = n, fill = Proximate_To_License), 
             stat = "identity", position = "dodge")+
  facet_wrap(~dotw)+
  labs(title="Hourly Reported Violent Crimes, 2021-2022 by \nProximity to Hopsitality Licenses",
       subtitle= "Homicide, Aggravated Assault, Rape, Sex Offenses, Robbery - with and without Firearms. \nSource: Philadelphia Dept. Of Commerce, Dept. Licenses and Inspections, Philadelphia Police Dept.",
       x="Hour of the Day", 
       y="Number of Reported Incidents")+
  plotTheme

```

On average, commercial corridors have about as many incidents city-wide at 4PM as they do at 10 or PM. For the most part, violence on corridors does not spike on weekends, surprisingly.

Incidents in commercial areas, near establishments make up 10-15% of incidents city-wide at night - a steady rate for over 5 years. (As of 6/10, 1950 total incidents 6PM-6AM, 222 w/in 200 ft of a business in a corridor). We don't have info about specific open/close hours to know exactly what businesses might have been open during what incidents.

Incidents in corridors track the city's overall trends pretty closely.

```{r corridor_timeseries, echo=FALSE, warning = FALSE, message = FALSE  }
st_join(violentCrime_shp %>% 
          filter(text_general_code %in% c("Aggravated Assault Firearm", 
                                          "Robbery Firearm", 
                                          "Homicide - Criminal", 
                                          "Homicide - Criminal " )), 
        corridors) %>%
  mutate(in_Corridor = ifelse(is.na(NAME) == TRUE, 
                                       "Outside Corridor", "Inside Corridor")) %>%
  group_by(in_Corridor, after_six, year, month) %>%
  tally() %>%
  mutate(date = lubridate::my(paste(month, year))) %>%
  filter(after_six == "6PM - 6AM") %>%
  ggplot()+
  geom_line(aes(x = date, y = n, color = in_Corridor))+
      ylim(0, 400)+
  labs(title="Monthly Nighttime Firearm Incidents Inside and Outside Commercial Corridors, 2017-2022",
       subtitle= "Homicide and Aggravated Assault, Robbery with Firearms. 6PM-6AM.\n Source: Philadelphia Dept. Of Licenses & Inspections, Philadelphia Police Dept.",
       x="Year", 
       y="Number of Reported Incidents")+
  plotTheme

```

Incidents within 200 feet of a licensed establishment also track general trends - notice how few incidents take place near establishments.

```{r within_200, echo=FALSE, warning = FALSE, message = FALSE }

st_join(violentCrime_shp %>% 
          filter(text_general_code %in% c("Aggravated Assault Firearm", 
                                          "Robbery Firearm", 
                                          "Homicide - Criminal", 
                                          "Homicide - Criminal " )), 
        current_buffer) %>%
  as.data.frame() %>%
  mutate(Proximate_To_License = ifelse(is.na(in_buffer) == TRUE, "Over 200 ft Away", "Within 200 ft")) %>%
  group_by(Proximate_To_License, after_six, year, month) %>%
  tally() %>%
  mutate(date = lubridate::my(paste(month, year))) %>%
  filter(after_six == "6PM - 6AM") %>%
  ggplot()+
  geom_line(aes(x = date, y = n, color = Proximate_To_License))+
  labs(title="Monthly Nighttime Firearm Incidents By Proximity to\nAssembly, Restaurant or Amusement License, 2018-2022",
       subtitle= "Homicide, Aggravated Assault, Robbery with  Firearms.6PM-6AM.\n Source: Philadelphia Dept. Of Licenses & Inspections, Philadelphia Police Dept.",
       x="Year", 
       y="Number of Reported Incidents")+
  plotTheme

```

## 6.3. Interactive Map of Commercial Corridors

This interactive map shows the total number of firearm incidents 6PM-6AM since 2017 reported in the City's commercial corridors. Hover over each specific area to see a breakdown of incidents by year.

```{r incident_mapview, echo=FALSE, warning = FALSE, message = FALSE}
st_join(violentCrime_shp %>% 
          filter(text_general_code %in% c("Aggravated Assault Firearm", 
                                          "Robbery Firearm", 
                                          "Homicide - Criminal", 
                                          "Homicide - Criminal " )), 
        corridors) %>%
  filter(is.na(NAME) == FALSE) %>%
  # filter(str_detect(NAME, "South")) %>%
  filter(after_six == "6PM - 6AM") %>%
  group_by(NAME, year) %>%
  tally() %>%
  as.data.frame() %>%
  select(-geometry) %>%
  pivot_wider(names_from = year, values_from = n) %>%
  mutate(`2017` = ifelse(is.na(`2017`) == TRUE, 0, `2017`),
         `2018` = ifelse(is.na(`2018`) == TRUE, 0, `2018`),
         `2019` = ifelse(is.na(`2019`) == TRUE, 0, `2019`),
         `2020` = ifelse(is.na(`2020`) == TRUE, 0, `2020`),
         `2021` = ifelse(is.na(`2021`) == TRUE, 0, `2021`),
         `2022` = ifelse(is.na(`2022`) == TRUE, 0, `2022`))%>%
  left_join(., corridors %>%
              select(NAME), by = c("NAME")) %>%
 mutate(Incidents_Since_2017 = `2017`+ `2018` + `2019` + `2020` + `2021` + `2022`) %>%
  relocate(`2020`, .after = `2019`) %>%
  st_as_sf() %>%
  st_transform(2272) %>%
  mapView(zcol = "Incidents_Since_2017")

```

Some commentary regarding this map:

By far, the corridors in the city with the most firearm incidents (aggravated assault, robbery, homicide) are the ones in areas with epidemic gun violence (e.g. Kensington and Allegheny, Broad and Hunting Park, 60th and Market). This intensity is especially pronounced when you consider their size.

South Street is one of the most popular nighttime destinations in the City - averaging about 330% of the nighttime visitors compared to an average Philly corridor. It has one of the highest distances travelled by the average visitor. Students of mine analyzed phone GPS data from third parties to these corridors at night - you can look at how many people go to each corridor and from where using this app: https://sabrinasmlee.github.io/exploratory_page/home.html

South Street has a fairly low incidence of violent crime 6PM-6AM given its popularity as a regional destination. Parts of South Street west of 8th St have seen multiple years in the last 5 without a single incident. South & 8th to the Waterfront is slightly higher - with 9 firearm-related incidents in 2021, but a general average of 2-6 per year.

Center City has had some uptick in nighttime gun crime in 2021 - but about 1/3rd of these incidents were not near establishments. Given how much stuff was closed, I wouldn't be surprised if a lot of this was happening in the absence of nightlife programming.


# Next up for analysis

overlays, Mobility trends, PPP data, Illuminate the Arts grants


Bike Share and Mobility

Philadelphia Bike Share Q2, 2021

```{r load_mobility, message=TRUE, warning=FALSE, include=FALSE, eval = FALSE}
url <-"https://u626n26h74f16ig1p3pt0f2g-wpengine.netdna-ssl.com/wp-content/uploads/2021/04/indego-trips-2021-q1.zip"

temp <- tempfile()
temp2 <- tempfile()

download.file(url, temp)
unzip(zipfile = temp, exdir = temp2)
q1_2021 <- read.csv(file.path(temp2, "indego-trips-2021-q1.csv"))

unlink(c(temp, temp2))

url <-"https://u626n26h74f16ig1p3pt0f2g-wpengine.netdna-ssl.com/wp-content/uploads/2021/07/indego-trips-2021-q2.zip"

temp <- tempfile()
temp2 <- tempfile()

download.file(url, temp)
unzip(zipfile = temp, exdir = temp2)
q2_2021 <- read.csv(file.path(temp2, "indego-trips-2021-q2.csv"))

unlink(c(temp, temp2))

url <-"https://u626n26h74f16ig1p3pt0f2g-wpengine.netdna-ssl.com/wp-content/uploads/2021/10/indego-trips-2021-q3.zip"

temp <- tempfile()
temp2 <- tempfile()

download.file(url, temp)
unzip(zipfile = temp, exdir = temp2)
q3_2021 <- read.csv(file.path(temp2, "indego-trips-2021-q3.csv"))

unlink(c(temp, temp2))

url <-"https://u626n26h74f16ig1p3pt0f2g-wpengine.netdna-ssl.com/wp-content/uploads/2022/01/indego-trips-2021-q4.zip"

temp <- tempfile()
temp2 <- tempfile()

download.file(url, temp)
unzip(zipfile = temp, exdir = temp2)
q4_2021 <- read.csv(file.path(temp2, "indego-trips-2021-q4.csv"))

unlink(c(temp, temp2))

dat <- q1_2021 %>%
  rbind(., q2_2021) %>%
  rbind(., q3_2021) %>%
  rbind(., q4_2021)

remove(q1_2021)
remove(q2_2021)
remove(q3_2021)
remove(q4_2021)

phila_shp <- counties("PA") %>%
  filter(NAME == "Philadelphia") %>%
  st_as_sf(crs = 4326)

dat2 <- dat %>%
  mutate(interval60 = floor_date(mdy_hm(start_time), unit = "hour"),
         interval15 = floor_date(mdy_hm(start_time), unit = "15 mins"),
         week = week(interval60),
         dotw = wday(interval60, label=TRUE))
```


```{r mobility_trends, warning = FALSE, echo = TRUE, message = FALSE, eval = FALSE, include = FALSE}
ggplot(dat2 %>%
         group_by(week) %>%
         tally())+
  geom_line(aes(x = week, y = n))+
  labs(title="Bike share trips per week Philadelphia, 2021",
       x="Week (2021)", 
       y="Trips")+
  plotTheme

ggplot(dat2 %>% mutate(hour = hour(mdy_hm(start_time)),
                       month = month(mdy_hm(start_time)),
                       day_type = ifelse(dotw %in% c("Sat", "Sun", "Fri"), "Weekend", "Weekday"),
                       month = case_when(month == 1 ~ "01-2021",
                                         month == 2 ~ "02-2021",
                                         month == 3 ~ "03-2021",
                                         month == 4 ~ "04-2021",
                                         month == 5 ~ "05-2021",
                                         month == 6 ~ "06-2021",
                                         month == 7 ~ "07-2021",
                                         month == 8 ~ "08-2021",
                                         month == 9 ~ "09-2021",
                                         month == 10 ~ "10-2021",
                                         month == 11 ~ "11-2021",
                                         month == 12 ~ "12-2021")))+
  geom_rect(aes(xmin=0,
                xmax = 6,
                ymin = 0,
                ymax = Inf), fill = 'light grey', alpha = 0.05)+
  geom_rect(aes(xmin=18,
                xmax = 24,
                ymin = 0,
                ymax = Inf), fill = 'light grey', alpha = 0.05)+
  geom_freqpoly(aes(hour, color = day_type), binwidth = 1)+
  scale_x_continuous(name="Hour", breaks=seq(0,24,6))+
  labs(title="Total Bike Share Trips",
       subtitle = "Philadelphia, 2021",
       x="Hour", 
       y="Trips")+
  facet_wrap(~month)+
  theme(legend.title = element_blank())+
  plotTheme
```



```{r mobility_map, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
ggplot(dat2 %>%
         mutate(time_of_day = ifelse(hour(interval60) < 4 | 
                                       hour(interval60) > 20, 
                                     "Night", 
                                     "Day"),
                month = month(mdy_hm(start_time)),
                month = case_when(month == 1 ~ "01-2021",
                                                    month == 2 ~ "02-2021",
                                                    month == 3 ~ "03-2021",
                                                    month == 4 ~ "04-2021",
                                                    month == 5 ~ "05-2021",
                                                    month == 6 ~ "06-2021",
                                                    month == 7 ~ "07-2021",
                                                    month == 8 ~ "08-2021",
                                                    month == 9 ~ "09-2021",
                                                    month == 10 ~ "10-2021",
                                                    month == 11 ~ "11-2021",
                                                    month == 12 ~ "12-2021")) %>%
         group_by(start_station, time_of_day, start_lon, start_lat, month) %>%
         tally() %>%
         filter(time_of_day == "Night")) +
  geom_sf(data = phila_shp, fill = "black")+
  geom_point(aes(x = start_lon, y = start_lat, color = n), alpha = 0.8)+
  scale_color_viridis_c()+
  guides(color=guide_legend(title="Trips"))+
  labs(title="Gross Bike Share Trips By Origin - 20:00-4:00, Q2, 2021")+
  facet_wrap(~month)+
  mapTheme
```