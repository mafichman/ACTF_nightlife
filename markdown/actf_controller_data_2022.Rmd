---
title: "ACTF Nightlife Data Analysis and Outputs"
author: "Michael Fichman"
date: "March 8, 2022"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: "hide"
    code_download: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(readxl)
library(lubridate)
library(kableExtra)

plotTheme <- theme(
  plot.title =element_text(size=12),
  plot.subtitle = element_text(size=8),
  plot.caption = element_text(size = 6),
  axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
  axis.text.y = element_text(size = 10),
  axis.title.y = element_text(size = 10),
  # Set the entire chart region to blank
  panel.background=element_blank(),
  plot.background=element_blank(),
  #panel.border=element_rect(colour="#F0F0F0"),
  # Format the grid
  panel.grid.major=element_line(colour="#D0D0D0",size=.75),
  axis.ticks=element_blank())

wage_tax_revenue <- read_excel("~/GitHub/ACTF_nightlife/data/wage-tax-revenue.xlsx") %>%
  rename(Arts_Entertainment_Recreation = 'Arts, Entertainment, and Other Recreation') %>%
  mutate(year = year(ymd(date)),
         month = month(ymd(date)))

# Load data, remove duplicates, adjust for inflation to 2021 dollars
wage_tax_revenue_new <- read.csv("https://phl-budget-datasette.herokuapp.com/revenue/wage-collections-by-sector.csv?sector__in=%5B%22Hotels%22%2C+%22Arts%2C+Entertainment%2C+and+Other+Recreation%22%2C+%22Restaurants%22%5D&_sort_desc=date&_size=max") %>%
    mutate(year = year(ymd(date)),
           month = month(ymd(date))) %>%
  select(-rowid) %>%
  group_by(fiscal_year, fiscal_quarter, sector) %>%
  slice(1) %>%
  ungroup() %>%
  mutate(total = case_when(year == 2014 ~ total * 1.12,
                           year == 2015 ~ total * 1.12,
                           year == 2016 ~ total * 1.10,
                           year == 2017 ~ total * 1.08,
                           year == 2018 ~ total * 1.06,
                           year == 2019 ~ total * 1.04,
                           year == 2020 ~ total * 1.01,
                           year == 2021 ~ total))
```

# About

Analysis by Michael Fichman of Philadelphia City Council's Arts and Culture Task Force, Nightlife Committee of wage tax revenue data obtained from Philadelphia Controller's Office, updated for the 2021 tax year, 3/8/2022.

For code base used to synthesize these data, refer to the code download button at the top of this document or visit the github repository for this page - https://github.com/mafichman/ACTF_nightlife

Questions, contact mfichman@upenn.edu

# Wage Tax Receipts

Quarterly wage tax receipts for industries in the arts and hospitality were dramatically impacted by the pandemic which began in March, 2020, and have not fully recovered. 

Data on nighttime-specific industries tend not to be subdivided by day and nighttime activity in wage tax data.

All dollar values adjusted for inflation (2021 dollars) based on BLS guidelines.

```{r message=FALSE, warning=FALSE, echo=FALSE}
wage_tax_revenue_new %>%
  group_by(date, sector) %>%
  summarize(sum = sum(total),
            sum = round((sum/1000000), digits = 2)) %>%
  ggplot()+
  geom_line(aes(x = as.Date(date), y=sum, color = sector))+
  ylab("Quarterly Wage Tax Revenue ($ Millions)")+
  xlab("Date")+
  labs(
    title = "Philadelphia Wage Tax Receipts for Three Hospitality Industries",
    subtitle = "Adjusted for inflation to 2021 Dollars. Source: Philadelphia City Controller's Office, BLS")+
  plotTheme
```

Tax revenues by year in millions of dollars

```{r message=FALSE, warning=FALSE, echo=FALSE}
wage_tax_revenue_new %>%
  group_by(year, sector) %>%
  summarize(sum = sum(total)) %>%
  mutate(sum = round((sum/1000000), digits = 2)) %>%
  spread(sector, sum) %>%
  kable() %>%
  kable_styling()

```
# Changes In Tax Revenue in Pandemic Year 1

Year over year losses - Pandemic Year 1 - Wage tax revenues during March, 2020 - December, 2021 relative to March, 2019 - February, 2020.

As gross (in millions of US dollars, adjust for inflation to 2021 dollars) and as a percentage change.

```{r message=FALSE, warning=FALSE, echo=FALSE}
wage_tax_revenue %>%
  mutate(pandemic = case_when(year == 2020 & month >=3 ~ "March2020_Feb2021",
                              year == 2021 ~ "March2020_Feb2021",
                              year == 2020 & month <3 ~ "March2019_Feb2020",
                              year == 2019 & month > 3 ~ "March2019_Feb2020")) %>%
  filter(is.na(pandemic) == FALSE) %>%
  select(-date, -month, -year ) %>%
  gather(-pandemic, key = "variable", value = "value") %>%
  group_by(pandemic, variable) %>%
  summarize(sum = sum(value)) %>%
  mutate(sum = round((sum/1000000), digits = 2)) %>%
  spread(pandemic, sum) %>%
  mutate(Pct_Change = round(100*((March2020_Feb2021 - March2019_Feb2020)/ March2019_Feb2020), digits = 2)) %>%
  rename("Pre-pandemic year" = March2019_Feb2020,
         "Pandemic year 1" = March2020_Feb2021) %>%
  kable() %>%
  kable_styling()

```

# Loss Estimates and Recovery Timeline

Tax revenues by the end of 2021 are still falling short of expected, meaning that recovery has not been achieved. Expected revenues are based on 2014-2020(TY Q1) trends (based on year, quarter and sector) and adjusted for inflation to 2021 dollars.

```{r model, warning = FALSE, message = FALSE, include=FALSE}
model <- lm(data = wage_tax_revenue_new %>% filter(year < 2020) %>% select(sector, fiscal_quarter, year, total), total ~ fiscal_quarter + year + sector)

summary(model)


predict(model, wage_tax_revenue_new) %>% 
  as.data.frame() %>% 
  rename(pred = ".") %>% 
  cbind(., wage_tax_revenue_new) -> wage_tax_revenue_new
```

Projected revenues are climbing back towards pre-pandemic status-quo.

```{r projection_chart, warning = FALSE, message = FALSE, echo=FALSE}
wage_tax_revenue_new %>%
  group_by(date, sector, year, month) %>% 
  summarize(Actual = sum(total), 
            Pre.Pandemic.Trend = sum(pred)) %>% 
  filter(year >= 2018) %>%
  ungroup() %>%
  select(date, sector, Actual, Pre.Pandemic.Trend) %>%
  gather(-sector, - date, key = "variable", value = "value") %>%
  mutate(value_m = round(value/1000000, digits = 2)) %>%
  ggplot()+
    geom_line(aes(x = as.Date(date), y=value_m, color = variable))+ 
    geom_line(aes(x = as.Date(date), y=value_m, color = variable), 
            linetype = "dashed", alpha = 0.5)+
  facet_wrap(~sector)+
    ylab("Quarterly Wage Tax Revenue ($ Millions)")+
    xlab("Date")+
    labs(
        title = "Philadelphia Wage Tax Shortfalls",
        subtitle = "Adjusted for inflation to 2021 Dollars.\n Trend based on 2014-2019 regression controlling for year, quarter, sector. \nSource: Philadelphia City Controller's Office, BLS")+
    plotTheme

```

Wage tax losses since the beginning of 2020, relative to projections based on 2014-19, are still as much as $2 million per quarter by sector.

```{r projection_chart_bar, warning = FALSE, message = FALSE, echo=FALSE}
wage_tax_revenue_new %>%
  group_by(date, sector, year, month) %>% 
  summarize(Actual = sum(total), 
            Pre.Pandemic.Trend = sum(pred)) %>% 
  mutate(loss = Actual - Pre.Pandemic.Trend) %>%
  filter(year >= 2020) %>%
  ungroup() %>%
  select(date, sector, loss) %>%
  gather(-sector, - date, key = "variable", value = "value") %>%
  mutate(value_m = round(value/1000000, digits = 2)) %>%
  ggplot()+
    geom_bar(aes(x = as.Date(date), y=value_m), stat = "identity", color = "grey")+ 
  facet_wrap(~sector)+
    ylab("Quarterly Wage Tax Revenue shortfall ($ Millions)")+
    xlab("Date")+
    labs(
        title = "Philadelphia Wage Tax Receipts vs. Pre-Pandemic Trends",
        subtitle = "Adjusted for inflation to 2021 Dollars. Source: Philadelphia City Controller's Office, BLS")+
    plotTheme

```

Total tax shortfalls (compared to pre-pandemic trend) since March, 2020, in millions (2021 dollars)

```{r loss_summary, echo=FALSE, message=FALSE, warning=FALSE}

wage_tax_revenue_new %>%
  group_by(date, sector, year, month) %>% 
  summarize(Actual = sum(total), 
            Pre.Pandemic.Trend = sum(pred)) %>% 
  mutate(loss = Actual - Pre.Pandemic.Trend) %>%
  ungroup() %>%
  filter(year == 2020 & month >=3 | year > 2020) %>%
  group_by(sector) %>%
  summarize("Est Loss (millions)" = round(sum(loss)/1000000, digits = 2)) %>%
  kable()

```

# Next up 

Mobility trends, Save our Stages Grants, PPP data, Illuminate the Arts grants