---
title: "ACTF Nightlife Data Analysis and Outputs"
author: "Michael Fichman"
date: "April 8, 2022"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: "hide"
    code_download: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(readxl)
library(lubridate)
library(kableExtra)
library(leaflet)
library(leaflet.extras)
library(leaflet.providers)
library(sf)
library(ggmap)
library(DT)
library(tigris)
library(mapview)

plotTheme <- theme(
  plot.title =element_text(size=12),
  plot.subtitle = element_text(size=8),
  plot.caption = element_text(size = 6),
  axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
  axis.text.y = element_text(size = 10),
  axis.title.y = element_text(size = 10),
  # Set the entire chart region to blank
  panel.background=element_blank(),
  plot.background=element_blank(),
  #panel.border=element_rect(colour="#F0F0F0"),
  # Format the grid
  panel.grid.major=element_line(colour="#D0D0D0",size=.75),
  axis.ticks=element_blank())

mapTheme <- theme(plot.title =element_text(size=12),
                  plot.subtitle = element_text(size=8),
                  plot.caption = element_text(size = 6),
                  axis.line=element_blank(),
                  axis.text.x=element_blank(),
                  axis.text.y=element_blank(),
                  axis.ticks=element_blank(),
                  axis.title.x=element_blank(),
                  axis.title.y=element_blank(),
                  panel.background=element_blank(),
                  panel.border=element_blank(),
                  panel.grid.major=element_line(colour = 'transparent'),
                  panel.grid.minor=element_blank(),
                  legend.direction = "vertical", 
                  legend.position = "right",
                  plot.margin = margin(1, 1, 1, 1, 'cm'),
                  legend.key.height = unit(1, "cm"), legend.key.width = unit(0.2, "cm"))



wage_tax_revenue <- read_excel("~/GitHub/ACTF_nightlife/data/wage-tax-revenue.xlsx") %>%
  rename(Arts_Entertainment_Recreation = 'Arts, Entertainment, and Other Recreation') %>%
  mutate(year = year(ymd(date)),
         month = month(ymd(date)))

# Load data, remove duplicates, adjust for inflation to 2021 dollars
wage_tax_revenue_new <- read.csv("https://phl-budget-datasette.herokuapp.com/revenue/wage-collections-by-sector.csv?sector__in=%5B%22Hotels%22%2C+%22Arts%2C+Entertainment%2C+and+Other+Recreation%22%2C+%22Restaurants%22%5D&_sort_desc=date&_size=max") %>%
    mutate(year = year(ymd(date)),
           month = month(ymd(date))) %>%
  select(-rowid) %>%
  group_by(fiscal_year, fiscal_quarter, sector) %>%
  slice(1) %>%
  ungroup() %>%
  mutate(total = case_when(year == 2014 ~ total * 1.12,
                           year == 2015 ~ total * 1.12,
                           year == 2016 ~ total * 1.10,
                           year == 2017 ~ total * 1.08,
                           year == 2018 ~ total * 1.06,
                           year == 2019 ~ total * 1.04,
                           year == 2020 ~ total * 1.01,
                           year == 2021 ~ total))
```

# About

Analysis by Michael Fichman of Philadelphia City Council's Arts and Culture Task Force, Nightlife Committee of wage tax revenue data obtained from Philadelphia Controller's Office, updated for the 2021 tax year, 3/8/2022.

For code base used to synthesize these data, refer to the code download button at the top of this document or visit the github repository for this page - https://github.com/mafichman/ACTF_nightlife

Questions, contact mfichman@upenn.edu

# Wage Tax Receipts

Quarterly wage tax receipts for industries in the arts and hospitality were dramatically impacted by the pandemic which began in March, 2020, and have not fully recovered. 

Data on nighttime-specific industries tend not to be subdivided by day and nighttime activity in wage tax data.

All dollar values adjusted for inflation (2021 dollars) based on BLS guidelines.

```{r message=FALSE, warning=FALSE, echo=FALSE}
wage_tax_revenue_new %>%
  group_by(date, sector) %>%
  summarize(sum = sum(total),
            sum = round((sum/1000000), digits = 2)) %>%
  ggplot()+
  geom_line(aes(x = as.Date(date), y=sum, color = sector))+
  ylab("Quarterly Wage Tax Revenue ($ Millions)")+
  xlab("Date")+
  labs(
    title = "Philadelphia Wage Tax Receipts for Three Hospitality Industries",
    subtitle = "Adjusted for inflation to 2021 Dollars. Source: Philadelphia City Controller's Office, BLS")+
  plotTheme
```

Tax revenues by year in millions of dollars

```{r message=FALSE, warning=FALSE, echo=FALSE}
wage_tax_revenue_new %>%
  group_by(year, sector) %>%
  summarize(sum = sum(total)) %>%
  mutate(sum = round((sum/1000000), digits = 2)) %>%
  spread(sector, sum) %>%
  kable() %>%
  kable_styling()

```
# Changes In Tax Revenue in Pandemic Year 1

Year over year losses - Pandemic Year 1 - Wage tax revenues during March, 2020 - December, 2021 relative to March, 2019 - February, 2020.

As gross (in millions of US dollars, adjust for inflation to 2021 dollars) and as a percentage change.

```{r message=FALSE, warning=FALSE, echo=FALSE}
wage_tax_revenue %>%
  mutate(pandemic = case_when(year == 2020 & month >=3 ~ "March2020_Feb2021",
                              year == 2021 ~ "March2020_Feb2021",
                              year == 2020 & month <3 ~ "March2019_Feb2020",
                              year == 2019 & month > 3 ~ "March2019_Feb2020")) %>%
  filter(is.na(pandemic) == FALSE) %>%
  select(-date, -month, -year ) %>%
  gather(-pandemic, key = "variable", value = "value") %>%
  group_by(pandemic, variable) %>%
  summarize(sum = sum(value)) %>%
  mutate(sum = round((sum/1000000), digits = 2)) %>%
  spread(pandemic, sum) %>%
  mutate(Pct_Change = round(100*((March2020_Feb2021 - March2019_Feb2020)/ March2019_Feb2020), digits = 2)) %>%
  rename("Pre-pandemic year" = March2019_Feb2020,
         "Pandemic year 1" = March2020_Feb2021) %>%
  kable() %>%
  kable_styling()

```

# Loss Estimates and Recovery Timeline

Tax revenues by the end of 2021 are still falling short of expected, meaning that recovery has not been achieved. Expected revenues are based on 2014-2020(TY Q1) trends (based on year, quarter and sector) and adjusted for inflation to 2021 dollars.

```{r model, warning = FALSE, message = FALSE, include=FALSE}
model <- lm(data = wage_tax_revenue_new %>% filter(year < 2020) %>% select(sector, fiscal_quarter, year, total), total ~ fiscal_quarter + year + sector)

summary(model)


predict(model, wage_tax_revenue_new) %>% 
  as.data.frame() %>% 
  rename(pred = ".") %>% 
  cbind(., wage_tax_revenue_new) -> wage_tax_revenue_new
```

Projected revenues are climbing back towards pre-pandemic status-quo.

```{r projection_chart, warning = FALSE, message = FALSE, echo=FALSE}
wage_tax_revenue_new %>%
  group_by(date, sector, year, month) %>% 
  summarize(Actual = sum(total), 
            Pre.Pandemic.Trend = sum(pred)) %>% 
  filter(year >= 2018) %>%
  ungroup() %>%
  select(date, sector, Actual, Pre.Pandemic.Trend) %>%
  gather(-sector, - date, key = "variable", value = "value") %>%
  mutate(value_m = round(value/1000000, digits = 2)) %>%
  ggplot()+
    geom_line(aes(x = as.Date(date), y=value_m, color = variable))+ 
    geom_line(aes(x = as.Date(date), y=value_m, color = variable), 
            linetype = "dashed", alpha = 0.5)+
  facet_wrap(~sector)+
    ylab("Quarterly Wage Tax Revenue ($ Millions)")+
    xlab("Date")+
    labs(
        title = "Philadelphia Wage Tax Shortfalls",
        subtitle = "Adjusted for inflation to 2021 Dollars.\n Trend based on 2014-2019 regression controlling for year, quarter, sector. \nSource: Philadelphia City Controller's Office, BLS")+
    plotTheme

```

Wage tax losses since the beginning of 2020, relative to projections based on 2014-19, are still as much as $2 million per quarter by sector.

```{r projection_chart_bar, warning = FALSE, message = FALSE, echo=FALSE}
wage_tax_revenue_new %>%
  group_by(date, sector, year, month) %>% 
  summarize(Actual = sum(total), 
            Pre.Pandemic.Trend = sum(pred)) %>% 
  mutate(loss = Actual - Pre.Pandemic.Trend) %>%
  filter(year >= 2020) %>%
  ungroup() %>%
  select(date, sector, loss) %>%
  gather(-sector, - date, key = "variable", value = "value") %>%
  mutate(value_m = round(value/1000000, digits = 2)) %>%
  ggplot()+
    geom_bar(aes(x = as.Date(date), y=value_m), stat = "identity", color = "grey")+ 
  facet_wrap(~sector)+
    ylab("Quarterly Wage Tax Revenue shortfall ($ Millions)")+
    xlab("Date")+
    labs(
        title = "Philadelphia Wage Tax Receipts vs. Pre-Pandemic Trends",
        subtitle = "Adjusted for inflation to 2021 Dollars. Source: Philadelphia City Controller's Office, BLS")+
    plotTheme

```

Total tax shortfalls (compared to pre-pandemic trend) since March, 2020, in millions (2021 dollars)

```{r loss_summary, echo=FALSE, message=FALSE, warning=FALSE}

wage_tax_revenue_new %>%
  group_by(date, sector, year, month) %>% 
  summarize(Actual = sum(total), 
            Pre.Pandemic.Trend = sum(pred)) %>% 
  mutate(loss = Actual - Pre.Pandemic.Trend) %>%
  ungroup() %>%
  filter(year == 2020 & month >=3 | year > 2020) %>%
  group_by(sector) %>%
  summarize("Est Loss (millions)" = round(sum(loss)/1000000, digits = 2)) %>%
  kable()

```

# Save Our Stages Grants

This repo contains interactive maps and analysis of SBA Grants given as part of the "Save Our Stages" Act passed by the US Congress.

The data being used here have been geocoded using the Google Geocoding service, which is highly accurate but not error free. Data are current as of August 17, 2021, and are available [from the SBA](https://data.sba.gov/dataset/svog/resource/33270c2a-f1c5-4dcb-bc98-aedcaec19ef3).

The following map shows the grantee locations.

```{r venues, echo = FALSE, message = FALSE, warning = FALSE}
geocoded_venues <- read.csv("~/GitHub/SaveOurStagesGrants/data/geocoded_venues.csv") %>%
  rename(acct_type = 'Account.Venue') %>%
  filter(City == "Philadelphia" & State == "PA")

l <- leaflet() %>% 
  addProviderTiles(providers$Esri.WorldTopoMap) %>%
  setView(lng = mean(geocoded_venues$lon, na.rm = TRUE),
          lat = mean(geocoded_venues$lat, na.rm = TRUE),
          zoom = 10) %>%
  addScaleBar(position = "topleft") %>%
  addCircleMarkers(data= geocoded_venues %>%
                     filter(acct_type == "Live performing arts organization operator"),
                   lng=~lon, 
                   lat=~lat,
                   radius =~ 1, 
                   fillOpacity =~ 0.5,
                   color= "blue", # "~pal(acct_type)"
                   label=~paste(svog_grantee, " | Grant $", svog_amount),
                   group= "Live performing arts organization operator") %>%
  addCircleMarkers(data= geocoded_venues %>%
                     filter(acct_type == "Live venue operator or promoter"),
                   lng=~lon, 
                   lat=~lat,
                   radius =~ 1, 
                   fillOpacity =~ 0.5,
                   color= "blue", # "~pal(acct_type)"
                   label=~paste(svog_grantee, " | Grant $", svog_amount),
                   group= "Live venue operator or promoter") %>%
  addCircleMarkers(data= geocoded_venues %>%
                     filter(acct_type == "Motion picture theater operator"),
                   lng=~lon, 
                   lat=~lat,
                   radius =~ 1, 
                   fillOpacity =~ 0.5,
                   color= "blue", # "~pal(acct_type)"
                   label=~paste(svog_grantee, " | Grant $", svog_amount),
                   group= "Motion picture theater operator") %>%
  addCircleMarkers(data= geocoded_venues %>%
                     filter(acct_type == "Museum Operator"),
                   lng=~lon, 
                   lat=~lat,
                   radius =~ 1, 
                   fillOpacity =~ 0.5,
                   color= "blue", # "~pal(acct_type)"
                   label=~paste(svog_grantee, " | Grant $", svog_amount),
                   group= "Museum Operator") %>%
  addCircleMarkers(data= geocoded_venues %>%
                     filter(acct_type == "Talent representative"),
                   lng=~lon, 
                   lat=~lat,
                   radius =~ 1, 
                   fillOpacity =~ 0.5,
                   color= "blue", # "~pal(acct_type)"
                   label=~paste(svog_grantee, " | Grant $", svog_amount),
                   group= "Talent representative") %>%
  addCircleMarkers(data= geocoded_venues %>%
                     filter(acct_type == "Theatrical producer"),
                   lng=~lon, 
                   lat=~lat,
                   radius =~ 1, 
                   fillOpacity =~ 0.5,
                   color= "blue", # "~pal(acct_type)"
                   label=~paste(svog_grantee, " | Grant $", svog_amount),
                   group= "Theatrical producer") %>%
  addLayersControl(
    overlayGroups = c("Live performing arts organization operator", 
                      "Live venue operator or promoter",
                      "Motion picture theater operator",
                      "Museum Operator",
                      "Talent representative",
                      "Theatrical producer") ,
    options = layersControlOptions(collapsed = TRUE)
    ) %>%
  hideGroup(c("Live performing arts organization operator", 
                      "Motion picture theater operator",
                      "Museum Operator",
                      "Talent representative",
                      "Theatrical producer"))

l

```
# Philadelphia SVOG grant breakdown:

```{r svog_breakdown, message = FALSE, echo = FALSE, warning = FALSE}
geocoded_venues %>%
  summarize("Num Grants" = n(),
            "Grants Total" = sum(svog_amount),
            "Mean Grant" = mean(svog_amount),
            "Median Grant" = median(svog_amount)) %>%
  kable() %>%
  kable_styling()
```

# Philadelphia SVOG searchable database:

```{r searchable_table, echo=FALSE, message=FALSE, warning=FALSE}
datatable(geocoded_venues %>%
            select(-X, -lon, -lat, -address_full) %>%
            rename('Grant ($)' = svog_amount,
                   Grantee = svog_grantee,
                   Category = acct_type), 
          options = list(pageLength = 10))
```
# Bike Share and Mobility

# Philadelphia Bike Share Q2, 2021

```{r load_mobility, message=TRUE, warning=FALSE, include=FALSE}
url <-"https://u626n26h74f16ig1p3pt0f2g-wpengine.netdna-ssl.com/wp-content/uploads/2021/04/indego-trips-2021-q1.zip"

temp <- tempfile()
temp2 <- tempfile()

download.file(url, temp)
unzip(zipfile = temp, exdir = temp2)
q1_2021 <- read.csv(file.path(temp2, "indego-trips-2021-q1.csv"))

unlink(c(temp, temp2))

url <-"https://u626n26h74f16ig1p3pt0f2g-wpengine.netdna-ssl.com/wp-content/uploads/2021/07/indego-trips-2021-q2.zip"

temp <- tempfile()
temp2 <- tempfile()

download.file(url, temp)
unzip(zipfile = temp, exdir = temp2)
q2_2021 <- read.csv(file.path(temp2, "indego-trips-2021-q2.csv"))

unlink(c(temp, temp2))

url <-"https://u626n26h74f16ig1p3pt0f2g-wpengine.netdna-ssl.com/wp-content/uploads/2021/10/indego-trips-2021-q3.zip"

temp <- tempfile()
temp2 <- tempfile()

download.file(url, temp)
unzip(zipfile = temp, exdir = temp2)
q3_2021 <- read.csv(file.path(temp2, "indego-trips-2021-q3.csv"))

unlink(c(temp, temp2))

url <-"https://u626n26h74f16ig1p3pt0f2g-wpengine.netdna-ssl.com/wp-content/uploads/2022/01/indego-trips-2021-q4.zip"

temp <- tempfile()
temp2 <- tempfile()

download.file(url, temp)
unzip(zipfile = temp, exdir = temp2)
q4_2021 <- read.csv(file.path(temp2, "indego-trips-2021-q4.csv"))

unlink(c(temp, temp2))

dat <- q1_2021 %>%
  rbind(., q2_2021) %>%
  rbind(., q3_2021) %>%
  rbind(., q4_2021)

remove(q1_2021)
remove(q2_2021)
remove(q3_2021)
remove(q4_2021)

phila_shp <- counties("PA") %>%
  filter(NAME == "Philadelphia") %>%
  st_as_sf(crs = 4326)

dat2 <- dat %>%
  mutate(interval60 = floor_date(mdy_hm(start_time), unit = "hour"),
         interval15 = floor_date(mdy_hm(start_time), unit = "15 mins"),
         week = week(interval60),
         dotw = wday(interval60, label=TRUE))
```


```{r mobility_trends, warning = FALSE, echo = TRUE, message = FALSE}
ggplot(dat2 %>%
         group_by(interval60) %>%
         tally())+
  geom_line(aes(x = interval60, y = n))+
  labs(title="Bike share trips per hr. Philadelphia, 2021",
       x="Date (2021)", 
       y="Trips per hour")+
  plotTheme

ggplot(dat2 %>% mutate(hour = hour(mdy_hm(start_time)),
                       month = month(mdy_hm(start_time)),
                       day_type = ifelse(dotw %in% c("Sat", "Sun", "Fri"), "Weekend", "Weekday"),
                       month = case_when(month == 1 ~ "01-2021",
                                         month == 2 ~ "02-2021",
                                         month == 3 ~ "03-2021",
                                         month == 4 ~ "04-2021",
                                         month == 5 ~ "05-2021",
                                         month == 6 ~ "06-2021",
                                         month == 7 ~ "07-2021",
                                         month == 8 ~ "08-2021",
                                         month == 9 ~ "09-2021",
                                         month == 10 ~ "10-2021",
                                         month == 11 ~ "11-2021",
                                         month == 12 ~ "12-2021")))+
  geom_rect(aes(xmin=0,
                xmax = 6,
                ymin = 0,
                ymax = Inf), fill = 'light grey', alpha = 0.05)+
  geom_rect(aes(xmin=18,
                xmax = 24,
                ymin = 0,
                ymax = Inf), fill = 'light grey', alpha = 0.05)+
  geom_freqpoly(aes(hour, color = day_type), binwidth = 1)+
  scale_x_continuous(name="Hour", breaks=seq(0,24,6))+
  labs(title="Total Bike Share Trips",
       subtitle = "Philadelphia, 2021",
       x="Hour", 
       y="Trips")+
  facet_wrap(~month)+
  theme(legend.title = element_blank())+
  plotTheme
```


```{r mobility_map, message = FALSE, warning = FALSE, echo = FALSE}
ggplot(dat2 %>%
         mutate(time_of_day = ifelse(hour(interval60) < 4 | 
                                       hour(interval60) > 20, 
                                     "Night", 
                                     "Day"),
                month = month(mdy_hm(start_time)),
                month = case_when(month == 1 ~ "01-2021",
                                                    month == 2 ~ "02-2021",
                                                    month == 3 ~ "03-2021",
                                                    month == 4 ~ "04-2021",
                                                    month == 5 ~ "05-2021",
                                                    month == 6 ~ "06-2021",
                                                    month == 7 ~ "07-2021",
                                                    month == 8 ~ "08-2021",
                                                    month == 9 ~ "09-2021",
                                                    month == 10 ~ "10-2021",
                                                    month == 11 ~ "11-2021",
                                                    month == 12 ~ "12-2021")) %>%
         group_by(start_station, time_of_day, start_lon, start_lat, month) %>%
         tally() %>%
         filter(time_of_day == "Night")) +
  geom_sf(data = phila_shp, fill = "black")+
  geom_point(aes(x = start_lon, y = start_lat, color = n), alpha = 0.8)+
  scale_color_viridis_c()+
  guides(color=guide_legend(title="Trips"))+
  labs(title="Gross Bike Share Trips By Origin - 20:00-4:00, Q2, 2021")+
  facet_wrap(~month)+
  mapTheme
```
# Zoning and Assembly Licenses

```{r dl_zoning, message = FALSE, warning = FALSE, echo = FALSE}

zones <- st_read("https://opendata.arcgis.com/datasets/0bdb0b5f13774c03abf8dc2f1aa01693_0.geojson") %>%
  st_as_sf(crs = 4326) %>%
  mutate(assembly_allowed = ifelse(LONG_CODE %in% 
                                     c("CMX-4", "CMX-5", "CA-2", "ICMX"),
                                   "By-Right", 
                                   ifelse(LONG_CODE %in% 
                                            c("CMX-2", "CMX-2.5", "CMX-3", "IRMX"),
                                          "Special Exception", 
                                          "Not Permitted" )))

```
```{r map_zones}
mapview(zones, zcol = "assembly_allowed")
```

Overlays

```{r overlays}
overlays <- st_read("https://opendata.arcgis.com/datasets/04fd29a8c022471994900cb0fd791bfc_0.geojson") %>%
  st_as_sf(crs = 4326)
```

Entertainment licenses

```{r business_licenses}
licenses <- st_read("https://phl.carto.com/api/v2/sql?q=SELECT+*+FROM+business_licenses&filename=business_licenses&format=geojson&skipfields=cartodb_id") %>%
  st_as_sf(crs = 4326)

```
```{r map_licenses}
mapview(licenses %>% filter(str_detect(licensetype, "Special Assembly") == TRUE), zcol = "licensestatus")
```

# Next up 

zoning, overlays, entertainment licenses, Mobility trends, PPP data, Illuminate the Arts grants